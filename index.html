const socket = io();
const startBtn = document.getElementById('startBtn');
const remoteAudio = document.getElementById('remoteAudio');
let pc;

// 相手からのシグナルを受け取った時のログを追加
socket.on('offer', async (offer) => {
    console.log('Offer received');
    if (!pc) preparePC();
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    answer.sdp = forceStereo(answer.sdp);
    await pc.setLocalDescription(answer);
    socket.emit('answer', answer);
});

async function preparePC() {
    pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    
    pc.onicecandidate = (e) => {
        if (e.candidate) {
            console.log('Sending candidate');
            socket.emit('candidate', e.candidate);
        }
    };

    pc.ontrack = (e) => {
        console.log('Stream received!');
        remoteAudio.srcObject = e.streams[0];
    };

    const stream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: false, noiseSuppression: false, channelCount: 2 }
    });
    
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
}

function forceStereo(sdp) {
    return sdp.replace('useinbandfec=1', 'useinbandfec=1;stereo=1;maxaveragebitrate=128000');
}

startBtn.onclick = async () => {
    console.log('Starting call...');
    await preparePC();
    const offer = await pc.createOffer();
    offer.sdp = forceStereo(offer.sdp);
    await pc.setLocalDescription(offer);
    socket.emit('offer', offer);
    startBtn.innerText = "接続試行中...";
};

// AnswerとCandidateの受信も追加
socket.on('answer', async (answer) => {
    console.log('Answer received');
    await pc.setRemoteDescription(new RTCSessionDescription(answer));
});

socket.on('candidate', async (candidate) => {
    if (pc) await pc.addIceCandidate(new RTCIceCandidate(candidate));
});
