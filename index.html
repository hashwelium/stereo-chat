<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Quality Stereo Call Pro</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #222; color: #fff; }
        h1 { margin-bottom: 10px; font-size: 24px; }
        #status { color: #00ff00; margin-bottom: 20px; font-weight: bold; min-height: 1.5em; }
        
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 12px 25px; font-size: 16px; cursor: pointer; color: white; border: none; border-radius: 25px; transition: 0.3s; }
        
        #startBtn { background: #ff4757; }
        #startBtn:disabled { background: #555; }
        
        #muteBtn { background: #ffa500; }
        #hangupBtn { background: #777; }
        
        .boost-panel { 
            margin: 20px auto; max-width: 320px; background: #333; 
            padding: 15px; border-radius: 15px; border: 1px solid #444;
        }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        audio { display: none; } /* éŸ³é‡ã¯Web Audioã§åˆ¶å¾¡ã™ã‚‹ãŸã‚éš ã™ */
        .note { font-size: 0.8rem; color: #aaa; margin-top: 15px; }
    </style>
</head>
<body>
    <h1>Stereo Call (Hi-Res & Boost)</h1>
    <div id="status">ãƒã‚¤ã‚¯ã‚’æº–å‚™ä¸­...</div>
    
    <div class="controls">
        <button id="startBtn" disabled>é€šè©±é–‹å§‹</button>
        <button id="muteBtn">ãƒã‚¤ã‚¯ON</button>
        <button id="hangupBtn" disabled>é€šè©±çµ‚äº†</button>
    </div>

    <div class="boost-panel">
        <label>ğŸ”Š å—ä¿¡éŸ³é‡ãƒ–ãƒ¼ã‚¹ãƒˆ: <span id="gainValue">1.0</span>å€</label><br>
        <input type="range" id="gainRange" min="1" max="5" step="0.1" value="1">
    </div>

    <div class="note">âš ï¸ ãƒã‚¦ãƒªãƒ³ã‚°é˜²æ­¢ã®ãŸã‚ã‚¤ãƒ¤ãƒ›ãƒ³å¿…é ˆ</div>
    <audio id="remoteAudio" autoplay></audio>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io("https://stereo-chat.onrender.com"); // URLã‚’ç¢ºèªã—ã¦ãã ã•ã„
        
        const startBtn = document.getElementById('startBtn');
        const muteBtn = document.getElementById('muteBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const statusDiv = document.getElementById('status');
        const remoteAudio = document.getElementById('remoteAudio');
        const gainRange = document.getElementById('gainRange');
        const gainValue = document.getElementById('gainValue');

        let localStream;
        let pc;
        let isMuted = false;
        
        // éŸ³é‡ãƒ–ãƒ¼ã‚¹ãƒˆç”¨å¤‰æ•°
        let audioCtx;
        let gainNode;
        let sourceNode;

        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        function forceStereo(sdp) {
            let fmtp = "useinbandfec=1; stereo=1; maxaveragebitrate=510000; sprop-maxcapturerate=48000; usedtx=0";
            return sdp.replace(/useinbandfec=1/g, fmtp);
        }

        // --- éŸ³é‡ãƒ–ãƒ¼ã‚¹ãƒˆãƒ»ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¨­å®š ---
        function setupAudioBoost(stream) {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            // æ—¢å­˜ã®æ¥ç¶šãŒã‚ã‚Œã°ä¸€åº¦åˆ‡æ–­
            if (sourceNode) sourceNode.disconnect();
            
            sourceNode = audioCtx.createMediaStreamSource(stream);
            gainNode = audioCtx.createGain();
            
            gainNode.gain.value = gainRange.value; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’é©ç”¨
            
            sourceNode.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            // audioã‚¿ã‚°è‡ªä½“ã¯ãƒŸãƒ¥ãƒ¼ãƒˆã«ã—ã¦ã€Web Audioã®éŸ³ã ã‘å‡ºã™ï¼ˆäºŒé‡é˜²æ­¢ï¼‰
            remoteAudio.srcObject = stream;
            remoteAudio.muted = true;
        }

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œæ™‚
        gainRange.oninput = () => {
            gainValue.innerText = gainRange.value;
            if (gainNode) gainNode.gain.value = gainRange.value;
        };

        // --- ãƒŸãƒ¥ãƒ¼ãƒˆæ©Ÿèƒ½ ---
        muteBtn.onclick = () => {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            muteBtn.innerText = isMuted ? "ãƒã‚¤ã‚¯OFFä¸­" : "ãƒã‚¤ã‚¯ON";
            muteBtn.style.background = isMuted ? "#555" : "#ffa500";
        };

        // --- é€šè©±çµ‚äº†æ©Ÿèƒ½ ---
        hangupBtn.onclick = () => {
            stopCall();
            socket.emit('hangup');
        };

        function stopCall() {
            if (pc) {
                pc.close();
                pc = null;
            }
            statusDiv.innerText = "é€šè©±ã‚’çµ‚äº†ã—ã¾ã—ãŸ";
            startBtn.disabled = false;
            hangupBtn.disabled = true;
        }

        socket.on('hangup', () => {
            stopCall();
        });

        // --- WebRTCåŸºæœ¬å‡¦ç† ---
        async function init() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        channelCount: { ideal: 2 },
                        sampleRate: { ideal: 48000 }
                    }
                });
                statusDiv.innerText = "æº–å‚™OKï¼(é«˜éŸ³è³ªãƒ¢ãƒ¼ãƒ‰)";
                startBtn.disabled = false;
            } catch (err) {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                statusDiv.innerText = "æº–å‚™OK (æ¨™æº–ãƒ¢ãƒ¼ãƒ‰)";
                startBtn.disabled = false;
            }
        }

        function createPeerConnection() {
            pc = new RTCPeerConnection(config);
            pc.onicecandidate = (e) => { if (e.candidate) socket.emit('candidate', e.candidate); };
            pc.ontrack = (e) => {
                statusDiv.innerText = "é€šè©±ä¸­ (Stereo + Boost)";
                setupAudioBoost(e.streams[0]);
                hangupBtn.disabled = false;
            };
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        }

        startBtn.onclick = async () => {
            if (audioCtx) audioCtx.resume(); // ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™è§£é™¤
            if (!pc) createPeerConnection();
            const offer = await pc.createOffer();
            offer.sdp = forceStereo(offer.sdp);
            await pc.setLocalDescription(offer);
            socket.emit('offer', offer);
            statusDiv.innerText = "å‘¼ã³å‡ºã—ä¸­...";
            startBtn.disabled = true;
        };

        socket.on('offer', async (offer) => {
            if (audioCtx) audioCtx.resume();
            if (!pc) createPeerConnection();
            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            answer.sdp = forceStereo(answer.sdp);
            await pc.setLocalDescription(answer);
            socket.emit('answer', answer);
        });

        socket.on('answer', async (answer) => {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
        });

        socket.on('candidate', async (candidate) => {
            if (pc) await pc.addIceCandidate(new RTCIceCandidate(candidate));
        });

        init();
    </script>
</body>
</html>
