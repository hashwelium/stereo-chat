<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stereo Call</title>
<style>
body {
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: linear-gradient(135deg,#1e1e2f,#12121a);
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.card{
  width:340px;
  background:#1f1f2e;
  border-radius:18px;
  padding:24px;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
  text-align:center;
}
h1{font-size:20px;margin-bottom:8px;}
.status{opacity:.7;font-size:14px;margin-bottom:12px;}
.timer{font-size:28px;margin:12px 0;font-weight:bold;}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  font-size:16px;
  margin-top:8px;
  cursor:pointer;
}
.start{background:#4CAF50;color:white;}
.stop{background:#e53935;color:white;}
textarea{
  width:100%;
  height:80px;
  margin-top:8px;
  border-radius:10px;
  border:none;
  padding:8px;
  font-size:12px;
}
</style>
</head>
<body>
<div class="card">
  <h1>ğŸ§ Stereo Voice Call</h1>
  <div class="status" id="status">å¾…æ©Ÿä¸­</div>
  <div class="timer" id="timer">00:00</div>
  <button class="start" onclick="startCall()">é€šè©±é–‹å§‹</button>
  <button class="stop" onclick="endCall()">çµ‚äº†</button>
  <textarea id="offer" placeholder="Offer / Answerè²¼ã‚Šä»˜ã‘"></textarea>
</div>

<script>
let pc, localStream, timerInterval, seconds=0;

function updateTimer(){
  seconds++;
  const m = String(Math.floor(seconds/60)).padStart(2,'0');
  const s = String(seconds%60).padStart(2,'0');
  document.getElementById("timer").textContent = `${m}:${s}`;
}

function enableStereo(sdp){
  return sdp.replace(
    /a=fmtp:111 minptime=10;useinbandfec=1/g,
    "a=fmtp:111 minptime=10;useinbandfec=1;stereo=1;sprop-stereo=1"
  );
}

async function startCall(){
  document.getElementById("status").textContent="ãƒã‚¤ã‚¯å–å¾—ä¸­â€¦";

  localStream = await navigator.mediaDevices.getUserMedia({
    audio:{
      channelCount:2,
      sampleRate:48000,
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  });

  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.ontrack = e=>{
    const audio = new Audio();
    audio.srcObject = e.streams[0];
    audio.play();
  };

  pc.onconnectionstatechange=()=>{
    document.getElementById("status").textContent="æ¥ç¶šçŠ¶æ…‹: "+pc.connectionState;
    if(pc.connectionState==="connected"){
      timerInterval=setInterval(updateTimer,1000);
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription({type:"offer", sdp: enableStereo(offer.sdp)});
  document.getElementById("offer").value = JSON.stringify(pc.localDescription);
  document.getElementById("status").textContent="Offerç”Ÿæˆ â†’ ç›¸æ‰‹ã¸é€ä¿¡";
}

async function setRemote(){
  const data = JSON.parse(document.getElementById("offer").value);
  await pc.setRemoteDescription(data);

  if(data.type==="offer"){
    const answer = await pc.createAnswer();
    await pc.setLocalDescription({type:"answer", sdp: enableStereo(answer.sdp)});
    document.getElementById("offer").value = JSON.stringify(pc.localDescription);
    document.getElementById("status").textContent="Answerç”Ÿæˆ â†’ è¿”é€";
  }
}

document.getElementById("offer").addEventListener("change", setRemote);

function endCall(){
  if(pc) pc.close();
  clearInterval(timerInterval);
  seconds=0;
  document.getElementById("timer").textContent="00:00";
  document.getElementById("status").textContent="çµ‚äº†";
}
</script>
</body>
</html>
