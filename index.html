<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io("https://YOUR-RENDER-URL");

let localStream;
let peerConnection;

const config = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    {
      urls: "turn:openrelay.metered.ca:80",
      username: "openrelayproject",
      credential: "openrelayproject"
    }
  ]
};

async function getStereoStream() {
  const stream = await navigator.mediaDevices.getUserMedia({
    audio: {
      channelCount: 2,
      echoCancellation: false,
      noiseSuppression: false,
      autoGainControl: false
    }
  });
  console.log("ðŸŽ¤ ãƒžã‚¤ã‚¯å–å¾—:", stream.getAudioTracks());
  return stream;
}

function createPeer() {
  const pc = new RTCPeerConnection(config);

  pc.ontrack = (event) => {
    console.log("ðŸ”Š ç›¸æ‰‹ã®éŸ³å£°å—ä¿¡");
    const audio = document.createElement("audio");
    audio.srcObject = event.streams[0];
    audio.autoplay = true;
    audio.controls = true;
    audio.onloadedmetadata = () => {
      audio.play().catch(e => console.log("å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯", e));
    };
    document.body.appendChild(audio);
  };

  pc.onicecandidate = (event) => {
    if (event.candidate) {
      socket.emit("ice-candidate", event.candidate);
    }
  };

  return pc;
}

document.getElementById("startBtn").onclick = async () => {
  localStream = await getStereoStream();
  peerConnection = createPeer();

  localStream.getTracks().forEach(track => {
    peerConnection.addTrack(track, localStream);
  });

  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  socket.emit("offer", offer);
};

socket.on("offer", async offer => {
  peerConnection = createPeer();
  localStream = await getStereoStream();

  localStream.getTracks().forEach(track => {
    peerConnection.addTrack(track, localStream);
  });

  await peerConnection.setRemoteDescription(offer);
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  socket.emit("answer", answer);
});

socket.on("answer", async answer => {
  await peerConnection.setRemoteDescription(answer);
});

socket.on("ice-candidate", async candidate => {
  if (peerConnection) {
    await peerConnection.addIceCandidate(candidate);
  }
});
</script>
